{% extends 'base.html' %}
{% load dict_filters %}

{% block content %}
<!-- Load Tailwind CSS for responsive styling -->
<link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
<!-- Load Animate.css for animations -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css" />
<!-- Load Font Awesome for SVG icons -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />

<style>
    .popup {
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 15px 25px;
        border-radius: 8px;
        color: white;
        font-weight: 500;
        z-index: 1000;
        display: none;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        max-width: 90%;
    }
    .popup.success { background-color: #34D399; }
    .popup.pending { background-color: #FBBF24; color: #1F2937; }
    .popup.error { background-color: #F87171; }
    .popup.other { background-color: #60A5FA; }
    .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        z-index: 1000;
        justify-content: center;
        align-items: center;
    }
    .modal-content {
        background-color: white;
        padding: 20px;
        border-radius: 10px;
        width: 90%;
        max-width: 500px;
        position: relative;
    }
    .close-btn {
        position: absolute;
        top: 10px;
        right: 15px;
        font-size: 24px;
        cursor: pointer;
        color: #4B5563;
    }
    @media (max-width: 640px) {
        .popup {
            top: 10px;
            right: 10px;
            padding: 10px 15px;
            font-size: 14px;
        }
        .modal-content {
            width: 95%;
            padding: 15px;
        }
    }
</style>

<div class="container mx-auto p-4 sm:p-6 lg:p-8">
    <!-- Messages as Popups -->
    {% if messages %}
        {% for message in messages %}
            <div class="popup animate__animated animate__fadeInDown 
                {% if message.tags == 'success' %}success{% elif message.tags == 'info' %}pending{% elif message.tags == 'error' %}error{% else %}other{% endif %}" 
                id="popup-{{ forloop.counter }}">
                <span class="mr-2">
                    {% if message.tags == 'success' %}
                        <i class="fas fa-check-circle"></i>
                    {% elif message.tags == 'info' %}
                        <i class="fas fa-hourglass-half"></i>
                    {% elif message.tags == 'error' %}
                        <i class="fas fa-exclamation-circle"></i>
                    {% else %}
                        <i class="fas fa-info-circle"></i>
                    {% endif %}
                </span>
                {{ message }}
            </div>
        {% endfor %}
    {% endif %}

    <!-- Offer Header -->
    <div class="bg-gradient-to-r from-blue-600 to-blue-800 text-white rounded-t-lg p-6 sm:p-8 animate__animated animate__fadeIn">
        <div class="flex flex-col sm:flex-row items-center gap-4">
            {% if offer.logo %}
                <img src="{{ offer.logo.url }}" alt="{{ offer.name }} Logo" class="w-16 h-16 sm:w-20 sm:h-20 object-contain rounded-full shadow-lg">
            {% else %}
                <div class="w-16 h-16 sm:w-20 sm:h-20 bg-gray-200 flex items-center justify-center rounded-full shadow-lg">
                    <span class="text-gray-500">No Logo</span>
                </div>
            {% endif %}
            <div>
                <h1 class="text-2xl sm:text-3xl lg:text-4xl font-bold flex items-center
                    {% if offer.theme == 'blue' %}text-blue-200{% elif offer.theme == 'red' %}text-red-200{% elif offer.theme == 'green' %}text-green-200{% elif offer.theme == 'purple' %}text-purple-200{% endif %}">
                    <i class="fas fa-tag mr-3"></i> {{ offer.name }}
                </h1>
                <p class="mt-2 text-sm sm:text-base">
                    Status: 
                    <span class="{% if offer.is_active == 'active' %}text-green-300{% else %}text-red-300{% endif %} font-semibold">
                        {{ offer.is_active|title }}
                    </span>
                </p>
            </div>
        </div>
    </div>

    <!-- Main Section -->
    <div class="bg-white rounded-b-lg shadow-lg p-6 sm:p-8">
        <!-- Referral Information -->
        {% if offer_referral %}
            <div class="mb-6 animate__animated animate__slideInUp">
                <h2 class="text-xl sm:text-2xl font-semibold text-gray-800 mb-2 flex items-center">
                    <i class="fas fa-link mr-2"></i> Referral Details
                </h2>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <p class="text-gray-600 flex items-center">
                        <i class="fas fa-id-badge mr-2 text-blue-500"></i>
                        <strong>Referral ID:</strong> {{ offer_referral.id }}
                    </p>
                    <p class="text-gray-600 flex items-center">
                        <i class="fas fa-user mr-2 text-blue-500"></i>
                        <strong>Referred By:</strong> 
                        {% if offer_referral.user %}
                            {{ offer_referral.user.username }}
                        {% else %}
                            Anonymous
                        {% endif %}
                    </p>
                    <p class="text-gray-600 flex items-center">
                        <i class="fas fa-info-circle mr-2 text-blue-500"></i>
                        <strong>Status:</strong> {{ offer_referral.working_state|title }}
                    </p>
                    <p class="text-gray-600 flex items-center">
                        <i class="fas fa-mouse-pointer mr-2 text-blue-500"></i>
                        <strong>Clicks:</strong> {{ offer_referral.click_count }}
                    </p>
                    <p class="text-gray-600 flex items-center">
                        <i class="fas fa-calendar-alt mr-2 text-blue-500"></i>
                        <strong>Created At:</strong> {{ offer_referral.created_at|date:"F d, Y, H:i" }}
                    </p>
                </div>
            </div>
        {% endif %}

        <div class="flex flex-col lg:flex-row gap-6">
            <!-- Images Section -->
            <div class="lg:w-1/3 flex flex-col items-center gap-4">
                <div class="w-full group animate__animated animate__fadeInUp">
                    <h2 class="text-lg font-semibold text-gray-700 mb-2 flex items-center">
                        <i class="fas fa-image mr-2 text-blue-500"></i> Offer Image
                    </h2>
                    {% if offer.image %}
                        <img src="{{ offer.image.url }}" alt="{{ offer.name }}" class="w-48 h-48 sm:w-56 sm:h-56 object-contain mx-auto rounded-lg shadow-md transform group-hover:scale-105 transition duration-300">
                    {% else %}
                        <div class="w-48 h-48 sm:w-56 sm:h-56 bg-gray-200 flex items-center justify-center mx-auto rounded-lg shadow-md">
                            <span class="text-gray-500">No Image</span>
                        </div>
                    {% endif %}
                </div>
            </div>

            <!-- Details Section -->
            <div class="lg:w-2/3">
                <h2 class="text-xl sm:text-2xl font-semibold text-gray-800 mb-4 animate__animated animate__fadeInUp flex items-center">
                    <i class="fas fa-info-circle mr-2"></i> Offer Details
                </h2>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <div>
                        <p class="text-gray-600 flex items-center">
                            <i class="fas fa-rupee-sign mr-2 text-blue-500"></i>
                            <strong>Price:</strong> â‚¹{{ offer.price|default:"N/A" }}
                        </p>
                        <p class="text-gray-600 mt-2 flex items-center">
                            <i class="fas fa-palette mr-2 text-blue-500"></i>
                            <strong>Theme:</strong> 
                            <span class="{% if offer.theme == 'blue' %}text-blue-500{% elif offer.theme == 'red' %}text-red-500{% elif offer.theme == 'green' %}text-green-500{% elif offer.theme == 'purple' %}text-purple-500{% endif %} font-semibold">
                                {{ offer.theme|title|default:"N/A" }}
                            </span>
                        </p>
                        <p class="text-gray-600 mt-2 flex items-center">
                            <i class="fas fa-calendar-alt mr-2 text-blue-500"></i>
                            <strong>Created:</strong> {{ offer.created_at|date:"F d, Y, H:i"|default:"N/A" }}
                        </p>
                        <p class="text-gray-600 mt-2 flex items-center">
                            <i class="fas fa-calendar-check mr-2 text-blue-500"></i>
                            <strong>Updated:</strong> {{ offer.updated_at|date:"F d, Y, H:i"|default:"N/A" }}
                        </p>
                        <p class="text-gray-600 mt-2 flex items-center">
                            <i class="fas fa-clock mr-2 text-blue-500"></i>
                            <strong>Valid Until:</strong> {{ offer.valid_until|date:"F d, Y"|default:"Ongoing" }}
                        </p>
                    </div>
                    <div>
                        <p class="text-gray-600 flex items-center">
                            <i class="fas fa-align-left mr-2 text-blue-500"></i>
                            <strong>Description:</strong> {{ offer.description|default:"No description available." }}
                        </p>
                        <p class="text-gray-600 mt-2 flex items-center">
                            <i class="fas fa-gift mr-2 text-blue-500"></i>
                            <strong>Reward:</strong> {{ offer.reward|default:"Earn exciting rewards!" }}
                        </p>
                    </div>
                </div>

                <!-- Requirements Section -->
                <div class="mt-4">
                    <h3 class="text-lg font-semibold text-gray-700 mb-2 flex items-center">
                        <i class="fas fa-check-square mr-2 text-blue-500"></i> Requirements to Grab Offer
                    </h3>
                    <ul class="text-gray-600 space-y-2">
                        {% if offer.requires_google_form and offer.google_form_url %}
                            <li class="{% if offer.theme == 'blue' %}text-blue-800{% elif offer.theme == 'red' %}text-red-800{% elif offer.theme == 'green' %}text-green-800{% elif offer.theme == 'purple' %}text-purple-800{% endif %} flex items-center">
                                <i class="fas fa-file-alt mr-2"></i>
                                <strong>Required:</strong> Complete this 
                                <a href="{{ offer.google_form_url }}" target="_blank" class="underline hover:text-blue-600">Google Form</a> (Compulsory).
                                <span class="ml-2">
                                    {% if google_form_completed %}
                                        <span class="text-green-600">âœ” Completed</span>
                                    {% else %}
                                        <span class="text-red-600">âœ˜ Not Completed</span>
                                        <form method="post" action="{% url 'confirm_google_form_submission' offer_id=offer.id %}" class="inline">
                                            {% csrf_token %}
                                            <button type="submit" class="ml-2 bg-blue-500 text-white px-3 py-1 rounded-lg hover:bg-blue-600 transition duration-300 inline-flex items-center">
                                                <i class="fas fa-check mr-2"></i> Iâ€™ve Completed the Form
                                            </button>
                                        </form>
                                    {% endif %}
                                </span>
                            </li>
                        {% endif %}
                        {% if offer.requires_contact_info %}
                            <li class="{% if offer.theme == 'blue' %}text-blue-800{% elif offer.theme == 'red' %}text-red-800{% elif offer.theme == 'green' %}text-green-800{% elif offer.theme == 'purple' %}text-purple-800{% endif %} flex items-center">
                                <i class="fas fa-address-book mr-2"></i>
                                <strong>Required:</strong> Provide your name, email, and mobile number below.
                                <span class="ml-2">
                                    {% if contact_info_submitted %}
                                        <span class="text-green-600">âœ” Submitted</span>
                                    {% else %}
                                        <span class="text-red-600">âœ˜ Not Submitted</span>
                                    {% endif %}
                                </span>
                            </li>
                            {% if user.is_authenticated %}
                                <li class="{% if offer.theme == 'blue' %}text-blue-800{% elif offer.theme == 'red' %}text-red-800{% elif offer.theme == 'green' %}text-green-800{% elif offer.theme == 'purple' %}text-purple-800{% endif %} flex items-center">
                                    <i class="fas fa-envelope mr-2"></i>
                                    <strong>Email Verification:</strong>
                                    <span class="ml-2">
                                        {% if email_verified %}
                                            <span class="text-green-600">âœ” Verified</span>
                                        {% else %}
                                            <span class="text-red-600">âœ˜ Not Verified</span>
                                        {% endif %}
                                    </span>
                                </li>
                                <li class="{% if offer.theme == 'blue' %}text-blue-800{% elif offer.theme == 'red' %}text-red-800{% elif offer.theme == 'green' %}text-green-800{% elif offer.theme == 'purple' %}text-purple-800{% endif %} flex items-center">
                                    <i class="fas fa-mobile-alt mr-2"></i>
                                    <strong>Mobile Verification:</strong>
                                    <span class="ml-2">
                                        {% if mobile_verified %}
                                            <span class="text-green-600">âœ” Verified</span>
                                        {% else %}
                                            <span class="text-red-600">âœ˜ Not Verified</span>
                                        {% endif %}
                                    </span>
                                </li>
                                {% if contact_info_submitted and not email_verified and not mobile_verified %}
                                    <li class="{% if offer.theme == 'blue' %}text-blue-800{% elif offer.theme == 'red' %}text-red-800{% elif offer.theme == 'green' %}text-green-800{% elif offer.theme == 'purple' %}text-purple-800{% endif %} flex items-center">
                                        <i class="fas fa-exclamation-circle mr-2 text-red-500"></i>
                                        <span class="text-red-600">Please verify either your email or mobile to fully process your submission.</span>
                                    </li>
                                {% endif %}
                            {% endif %}
                        {% endif %}
                        {% if not offer.requires_google_form and not offer.requires_contact_info %}
                            <li class="text-gray-600 flex items-center">
                                <i class="fas fa-info-circle mr-2"></i> No additional requirements to grab this offer.
                            </li>
                        {% endif %}
                    </ul>
                </div>

                <!-- Participate Button -->
                {% if user.is_authenticated and offer.requires_contact_info and not contact_info_submitted %}
                    <div class="mt-4 animate__animated animate__slideInUp">
                        <button onclick="openModal()" class="bg-blue-500 text-white px-6 py-3 rounded-full hover:bg-blue-600 transition duration-300 flex items-center">
                            <i class="fas fa-user-plus mr-2"></i> Participate in This Offer
                        </button>
                    </div>
                {% endif %}

                <!-- Action Buttons (if contact info is not required or already submitted) -->
                {% if not offer.requires_contact_info or contact_info_submitted %}
                    <div class="mt-6 flex flex-col sm:flex-row sm:space-x-4 space-y-4 sm:space-y-0 animate__animated animate__pulse animate__infinite">
                        {% if offer_referral and not email_not_verified %}
                            <a href="{% url 'grab_offer' offer_id=offer.id referral_id=offer_referral.id %}" target="_blank" class="bg-blue-500 text-white px-6 py-3 rounded-full hover:bg-blue-600 transition duration-300 inline-flex items-center">
                                <i class="fas fa-hand-pointer mr-2"></i> Grab Now
                            </a>
                        {% else %}
                            <a href="{% url 'grab_offer' offer_id=offer.id %}" target="_blank" class="bg-blue-500 text-white px-6 py-3 rounded-full hover:bg-blue-600 transition duration-300 inline-flex items-center">
                                <i class="fas fa-hand-pointer mr-2"></i> Grab Now
                            </a>
                        {% endif %}
                    </div>
                {% endif %}
            </div>
        </div>

        <!-- Tutorial Videos Section -->
        {% if tutorial_videos %}
            <div class="mt-8 animate__animated animate__slideInUp">
                <h2 class="text-xl sm:text-2xl font-semibold text-gray-800 mb-4 flex items-center">
                    <i class="fas fa-video mr-2"></i> Tutorial Videos
                </h2>
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
                    {% for video in tutorial_videos %}
                        <div class="w-full">
                            <h3 class="text-lg font-semibold text-gray-700 mb-2 flex items-center">
                                <i class="fas fa-play-circle mr-2 text-blue-500"></i>
                                {{ video.title|default:"Tutorial Video" }}
                            </h3>
                            <p class="text-gray-600 mb-4">
                                {{ video.description|default:"No description provided." }}
                            </p>
                            {% if 'youtube.com' in video.url or 'youtu.be' in video.url %}
                                {% if 'youtu.be' in video.url %}
                                    {% with video_id=video.url|slice:"17:" %}
                                        <iframe class="w-full h-48 sm:h-56 lg:h-64 rounded-lg shadow-md" src="https://www.youtube.com/embed/{{ video_id }}" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
                                    {% endwith %}
                                {% else %}
                                    {% with video_id=video.url|slice:"32:" %}
                                        <iframe class="w-full h-48 sm:h-56 lg:h-64 rounded-lg shadow-md" src="https://www.youtube.com/embed/{{ video_id }}" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
                                    {% endwith %}
                                {% endif %}
                            {% else %}
                                <div class="w-full h-48 sm:h-56 lg:h-64 bg-gray-100 flex items-center justify-center rounded-lg shadow-md">
                                    <a href="{{ video.url }}" target="_blank" class="text-blue-500 hover:underline text-center inline-flex items-center">
                                        <i class="fas fa-external-link-alt mr-2"></i> Watch Video (External Link)
                                    </a>
                                </div>
                            {% endif %}
                        </div>
                    {% endfor %}
                </div>
            </div>
        {% endif %}

        <!-- Ad Banners Section -->
        {% if ad_banners %}
            <div class="mt-8 animate__animated animate__slideInUp">
                <h2 class="text-xl sm:text-2xl font-semibold text-gray-800 mb-4 flex items-center">
                    <i class="fas fa-ad mr-2"></i> Ad Banners
                </h2>
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
                    {% for banner in ad_banners %}
                        <div class="w-full group">
                            <h3 class="text-lg font-semibold text-gray-700 mb-2 flex items-center">
                                <i class="fas fa-image mr-2 text-blue-500"></i>
                                {{ banner.title|default:"Ad Banner" }}
                            </h3>
                            <p class="text-gray-600 mb-4">
                                {{ banner.description|default:"No description provided." }}
                            </p>
                            {% if banner.image %}
                                <img src="{{ banner.image.url }}" alt="{{ banner.title|default:offer.name }} Ad" class="w-full h-auto rounded-lg shadow-md transform group-hover:scale-105 transition duration-300">
                            {% else %}
                                <div class="w-full h-auto bg-gray-200 flex items-center justify-center rounded-lg shadow-md">
                                    <span class="text-gray-500">No Image Available</span>
                                </div>
                            {% endif %}
                        </div>
                    {% endfor %}
                </div>
            </div>
        {% endif %}
    </div>

    <!-- User Information Section -->
    {% if user.is_authenticated %}
        <div class="mt-8 bg-gradient-to-r from-gray-50 to-gray-100 p-6 rounded-lg shadow-md animate__animated animate__slideInUp">
            <div class="flex justify-between items-center">
                <h2 class="text-xl sm:text-2xl font-semibold text-gray-800 mb-4 flex items-center">
                    <i class="fas fa-user-circle mr-2"></i> Your Information
                </h2>
                <button onclick="toggleUserInfo()" class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600 transition duration-300 sm:hidden">
                    <svg id="toggleIcon" class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                    </svg>
                </button>
            </div>
            <div id="userInfoContent" class="hidden sm:block">
                <div class="mb-6">
                    <h3 class="text-lg font-semibold text-gray-700 mb-2 flex items-center">
                        <i class="fas fa-id-card mr-2 text-blue-500"></i> Profile Information
                    </h3>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <p class="text-gray-600 flex items-center">
                            <i class="fas fa-user mr-2 text-blue-500"></i>
                            <strong>Username:</strong> {{ profile_info.username }}
                        </p>
                        <p class="text-gray-600 flex items-center">
                            <i class="fas fa-envelope mr-2 text-blue-500"></i>
                            <strong>Email:</strong> {{ profile_info.email }}
                        </p>
                        <p class="text-gray-600 flex items-center">
                            <i class="fas fa-check-circle mr-2 text-blue-500"></i>
                            <strong>Email Verified:</strong> 
                            {% if user.userprofile.email_verified %}
                                <span class="text-green-600">Yes</span>
                            {% else %}
                                <span class="text-red-600">No</span>
                                <a href="{% url 'resend_verification_email' %}?offer_id={{ offer.id }}" class="text-blue-500 hover:underline ml-2">Resend Verification Email</a>
                            {% endif %}
                        </p>
                        <p class="text-gray-600 flex items-center">
                            <i class="fas fa-mobile-alt mr-2 text-blue-500"></i>
                            <strong>Mobile Verified:</strong> 
                            {% if user.userprofile.mobile_verified %}
                                <span class="text-green-600">Yes</span>
                            {% else %}
                                <span class="text-red-600">No</span>
                            {% endif %}
                        </p>
                        <p class="text-gray-600 flex items-center">
                            <i class="fas fa-calendar-alt mr-2 text-blue-500"></i>
                            <strong>Joined:</strong> {{ profile_info.joined|date:"F d, Y, H:i" }}
                        </p>
                        <p class="text-gray-600 flex items-center">
                            <i class="fas fa-level-up-alt mr-2 text-blue-500"></i>
                            <strong>Profile Level:</strong> {{ profile_level }}
                        </p>
                    </div>
                </div>
                <div class="mb-6">
                    <h3 class="text-lg font-semibold text-gray-700 mb-2 flex items-center">
                        <i class="fas fa-link mr-2 text-blue-500"></i> Your Referral Link
                    </h3>
                    {% if referral_url and not email_not_verified %}
                        <p class="text-gray-600 break-all">
                            <a href="{{ referral_url }}" target="_blank" class="text-blue-500 hover:underline">
                                {{ referral_url }}
                            </a>
                        </p>
                    {% else %}
                        <p class="text-gray-600 flex items-center">
                            <i class="fas fa-exclamation-circle mr-2 text-red-500"></i>
                            Please verify your email to access your referral link.
                        </p>
                    {% endif %}
                </div>
                <div class="mb-6">
                    <h3 class="text-lg font-semibold text-gray-700 mb-2 flex items-center">
                        <i class="fas fa-share-alt mr-2 text-blue-500"></i> Share This Offer
                    </h3>
                    <p class="text-gray-600 mb-4">Invite friends to join this offer and earn with us! ðŸš€ Share your referral link below:</p>
                    <div class="flex flex-wrap gap-3 mb-4">
                        {% if referral_url and not email_not_verified %}
                            <a href="https://api.whatsapp.com/send?text=Join this offer! ðŸš€ Use my referral link: {{ referral_url|urlencode }}" target="_blank" class="bg-green-500 text-white px-4 py-2 rounded-lg hover:bg-green-600 transition duration-300 flex items-center gap-2">
                                <i class="fab fa-whatsapp"></i> WhatsApp
                            </a>
                            <a href="https://twitter.com/intent/tweet?text=Join this offer! ðŸš€ Use my referral link: {{ referral_url|urlencode }}" target="_blank" class="bg-blue-400 text-white px-4 py-2 rounded-lg hover:bg-blue-500 transition duration-300 flex items-center gap-2">
                                <i class="fab fa-twitter"></i> Twitter
                            </a>
                            <a href="https://www.facebook.com/sharer/sharer.php?u={{ referral_url|urlencode }}" target="_blank" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition duration-300 flex items-center gap-2">
                                <i class="fab fa-facebook-f"></i> Facebook
                            </a>
                            <a href="https://www.linkedin.com/sharing/share-offsite/?url={{ referral_url|urlencode }}" target="_blank" class="bg-blue-800 text-white px-4 py-2 rounded-lg hover:bg-blue-900 transition duration-300 flex items-center gap-2">
                                <i class="fab fa-linkedin-in"></i> LinkedIn
                            </a>
                            <a href="mailto:?subject=Join This Amazing Offer!&body=Join this offer! ðŸš€ Use my referral link: {{ referral_url|urlencode }}" class="bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600 transition duration-300 flex items-center gap-2">
                                <i class="fas fa-envelope"></i> Email
                            </a>
                            <button onclick="copyReferralLink('{{ referral_url }}')" class="bg-purple-500 text-white px-4 py-2 rounded-lg hover:bg-purple-600 transition duration-300 flex items-center gap-2">
                                <i class="fas fa-copy"></i> Copy Link
                                <span id="copyFeedback" class="ml-2 hidden text-sm text-green-500">Link Copied!</span>
                            </button>
                        {% else %}
                            <p class="text-gray-600 flex items-center">
                                <i class="fas fa-exclamation-circle mr-2 text-red-500"></i>
                                Please verify your email to share this offer.
                            </p>
                        {% endif %}
                    </div>
                    <p class="text-gray-600">
                        <a href="{% url 'dashboard' %}" class="text-blue-500 hover:underline inline-flex items-center">
                            <i class="fas fa-tachometer-alt mr-2"></i> Track your referrals on the Dashboard
                        </a>
                    </p>
                </div>
                <div>
                    <h3 class="text-lg font-semibold text-gray-700 mb-2 flex items-center">
                        <i class="fas fa-link mr-2 text-blue-500"></i> Your Referral for This Offer
                    </h3>
                    {% if offer_referral and not email_not_verified %}
                        <div class="overflow-x-auto">
                            <table class="min-w-full border-collapse">
                                <thead>
                                    <tr class="bg-gray-200">
                                        <th class="p-3 text-left text-gray-700">Referral ID</th>
                                        <th class="p-3 text-left text-gray-700">Status</th>
                                        <th class="p-3 text-left text-gray-700">Created At</th>
                                        <th class="p-3 text-left text-gray-700">Updated At</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr class="border-b">
                                        <td class="p-3">{{ offer_referral.id }}</td>
                                        <td class="p-3">{{ offer_referral.working_state|title }}</td>
                                        <td class="p-3">{{ offer_referral.created_at|date:"F d, Y, H:i" }}</td>
                                        <td class="p-3">{{ offer_referral.updated_at|date:"F d, Y, H:i" }}</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    {% else %}
                        <p class="text-gray-600 flex items-center">
                            <i class="fas fa-exclamation-circle mr-2 text-red-500"></i>
                            Please verify your email to view your referral details.
                        </p>
                    {% endif %}
                </div>
            </div>
        </div>
    {% endif %}

    <!-- Referral Form -->
    <div class="mt-8 bg-gradient-to-r from-blue-50 to-blue-100 p-6 rounded-lg shadow-md animate__animated animate__bounceIn">
        <h2 class="text-xl sm:text-2xl font-semibold text-gray-800 mb-4 flex items-center">
            <i class="fas fa-share-square mr-2"></i> Refer This Offer
        </h2>
        {% if referral_message %}
            <p class="text-gray-600 mb-4 flex items-center">
                <i class="fas fa-info-circle mr-2"></i> {{ referral_message }}
            </p>
        {% else %}
            {% if email_not_verified %}
                <p class="text-gray-600 mb-4 flex items-center">
                    <i class="fas fa-exclamation-circle mr-2 text-red-500"></i>
                    Please verify your email to refer this offer.
                </p>
            {% else %}
                <form method="post" action="{% url 'refer' offer_id=offer.id %}" class="space-y-4">
                    {% csrf_token %}
                    <button type="submit" class="bg-blue-500 text-white px-6 py-3 rounded-full hover:bg-blue-600 transition duration-300 w-full sm:w-auto inline-flex items-center">
                        <i class="fas fa-share-alt mr-2"></i> Refer Now
                    </button>
                </form>
            {% endif %}
        {% endif %}
    </div>

    <!-- Terms Section -->
    {% if offer.terms %}
        <div class="mt-8 bg-gray-50 p-6 rounded-lg shadow-md animate__animated animate__fadeIn">
            <h2 class="text-xl sm:text-2xl font-semibold text-gray-800 mb-4 flex items-center">
                <i class="fas fa-file-contract mr-2"></i> Terms & Conditions
            </h2>
            <p class="text-gray-600">{{ offer.terms }}</p>
        </div>
    {% endif %}

    <!-- Modal for Contact Info Form -->
    {% if user.is_authenticated and offer.requires_contact_info and not contact_info_submitted %}
        <div id="contactModal" class="modal">
            <div class="modal-content animate__animated animate__zoomIn">
                <span class="close-btn" onclick="closeModal()">Ã—</span>
                <h3 class="text-lg font-semibold text-gray-700 mb-4 flex items-center">
                    <i class="fas fa-address-book mr-2 text-blue-500"></i> Submit Contact Info
                </h3>
                <form method="post" action="{% if offer_referral %}{% url 'grab_offer' offer_id=offer.id referral_id=offer_referral.id %}{% else %}{% url 'grab_offer' offer_id=offer.id %}{% endif %}" class="space-y-4">
                    {% csrf_token %}
                    <div>
                        <label for="name" class="block text-gray-600 flex items-center">
                            <i class="fas fa-user mr-2"></i> Name:
                        </label>
                        {{ contact_form.name }}
                        {% if contact_form.name.errors %}
                            <p class="text-red-600 text-sm mt-1">{{ contact_form.name.errors.as_text }}</p>
                        {% endif %}
                    </div>
                    <div>
                        <label for="email" class="block text-gray-600 flex items-center">
                            <i class="fas fa-envelope mr-2"></i> Email:
                        </label>
                        {{ contact_form.email }}
                        {% if contact_form.email.errors %}
                            <p class="text-red-600 text-sm mt-1">{{ contact_form.email.errors.as_text }}</p>
                        {% endif %}
                    </div>
                    <div>
                        <label for="mobile" class="block text-gray-600 flex items-center">
                            <i class="fas fa-phone mr-2"></i> Mobile:
                        </label>
                        {{ contact_form.mobile }}
                        {% if contact_form.mobile.errors %}
                            <p class="text-red-600 text-sm mt-1">{{ contact_form.mobile.errors.as_text }}</p>
                        {% endif %}
                    </div>
                    <!-- CAPTCHA -->
                    {% if captcha %}
                        <div class="mb-4 flex flex-col">
                            <label class="text-gray-600 mb-2 flex items-center">
                                <i class="fas fa-shield-alt mr-2"></i> Select the correct image:
                            </label>
                            <p class="text-gray-600 mb-2">{{ captcha.description }}</p>
                            <div class="grid grid-cols-3 gap-2">
                                {% for image in captcha.images %}
                                    <label class="block">
                                        <input type="radio" name="captcha_image" value="{{ image }}" required class="hidden">
                                        <img src="/static/images/{{ image }}" alt="{{ image }}" width="150" class="w-15 h-24 object-cover rounded-lg border-2 border-gray-300 hover:border-blue-500 cursor-pointer">
                                    </label>
                                {% endfor %}
                            </div>
                        </div>
                    {% endif %}
                    <button type="submit" class="bg-blue-500 text-white px-6 py-3 rounded-full hover:bg-blue-600 transition duration-300 w-full flex items-center justify-center">
                        <i class="fas fa-save mr-2"></i> Submit & Grab Offer
                    </button>
                </form>
            </div>
        </div>
    {% endif %}
</div>

<!-- JavaScript for Modal, Popup, Toggle, Copy, and CAPTCHA -->
<script>
function openModal() {
    const modal = document.getElementById('contactModal');
    modal.style.display = 'flex';
}

function closeModal() {
    const modal = document.getElementById('contactModal');
    modal.style.display = 'none';
}

function toggleUserInfo() {
    const userInfoContent = document.getElementById('userInfoContent');
    const toggleIcon = document.getElementById('toggleIcon');
    userInfoContent.classList.toggle('hidden');
    toggleIcon.classList.toggle('rotate-180');
}

document.addEventListener('DOMContentLoaded', () => {
    document.querySelectorAll('.popup').forEach((popup, index) => {
        popup.style.display = 'block';
        setTimeout(() => {
            popup.classList.remove('animate__fadeInDown');
            popup.classList.add('animate__fadeOutUp');
        }, 3000 + index * 500);
    });
});

function copyReferralLink(link) {
    navigator.clipboard.writeText(link).then(() => {
        const feedback = document.getElementById('copyFeedback');
        feedback.classList.remove('hidden');
        setTimeout(() => feedback.classList.add('hidden'), 2000);
    });
}

document.getElementById('contactModal')?.addEventListener('click', (e) => {
    if (e.target === document.getElementById('contactModal')) {
        closeModal();
    }
});

// Add click effect to CAPTCHA images
document.querySelectorAll('input[name="captcha_image"]').forEach(input => {
    input.addEventListener('change', function() {
        document.querySelectorAll('input[name="captcha_image"] + img').forEach(img => {
            img.classList.remove('border-blue-500');
            img.classList.add('border-gray-300');
        });
        this.nextElementSibling.classList.remove('border-gray-300');
        this.nextElementSibling.classList.add('border-blue-500');
    });
});
</script>
{% endblock %}